name: SpecSharp Test Suite

on:
  push:
    branches: [ main, develop, clean-architecture-refactor ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Manual trigger

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  test-frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Run unit tests
        run: |
          cd frontend
          npm run test || true  # Continue even if tests fail for now
      
      - name: Upload coverage
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: frontend-coverage
          path: tests/reports/coverage/
          retention-days: 7
  
  test-e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
      
      - name: Run acceptance tests
        run: |
          cd backend
          PYTHONPATH=. pytest -q tests/test_v2_acceptance.py

  test-ux-smoke:
    name: UX Smoke Tests (non-blocking)
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install root test dependencies
        run: npm ci

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Install backend dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Prepare backend env for smoke run
        run: |
          cat > backend/.env << 'EOF'
          DATABASE_URL=sqlite:///./test_specsharp.db
          SECRET_KEY=test-secret-key
          SESSION_SECRET_KEY=test-session-secret-key
          JWT_SECRET=test-jwt-secret-key
          ALGORITHM=HS256
          ACCESS_TOKEN_EXPIRE_MINUTES=30
          ENVIRONMENT=development
          LOG_LEVEL=INFO
          TESTING=true
          EOF

      - name: Install Playwright browser
        run: npx playwright install --with-deps chromium

      - name: Start backend
        run: |
          mkdir -p tests/reports
          cd backend
          nohup bash -lc "source venv/bin/activate && uvicorn app.main:app --host 127.0.0.1 --port 8001" > ../tests/reports/backend-ux-smoke.log 2>&1 &

      - name: Start frontend
        run: |
          cd frontend
          nohup bash -lc "VITE_API_URL=http://127.0.0.1:8001 npm run dev -- --host 127.0.0.1 --port 3000" > ../tests/reports/frontend-ux-smoke.log 2>&1 &

      - name: Wait for services
        run: |
          for i in {1..60}; do
            curl -sf http://127.0.0.1:8001/health >/dev/null && break
            sleep 1
          done
          for i in {1..60}; do
            curl -sf http://127.0.0.1:3000 >/dev/null && break
            sleep 1
          done
          curl -sf http://127.0.0.1:8001/health >/dev/null
          curl -sf http://127.0.0.1:3000 >/dev/null

      - name: Run UX smoke suite
        env:
          TEST_BASE_URL: http://127.0.0.1:3000
          E2E_API_BASE_URL: http://127.0.0.1:8001
          E2E_USER_TOKEN: ${{ secrets.E2E_USER_TOKEN }}
          E2E_SECONDARY_USER_TOKEN: ${{ secrets.E2E_SECONDARY_USER_TOKEN }}
        run: |
          npx playwright test --config=tests/playwright.config.ts tests/e2e/smoke

      - name: Upload UX smoke artifacts
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ux-smoke-artifacts
          path: |
            tests/reports/playwright-html
            tests/reports/playwright-results
            tests/reports/backend-ux-smoke.log
            tests/reports/frontend-ux-smoke.log
          retention-days: 7
  
  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest-cov
      
      - name: Create test environment
        run: |
          cd backend
          echo "DATABASE_URL=sqlite:///./test_specsharp.db" > .env
          echo "SECRET_KEY=test-secret-key" >> .env
          echo "ALGORITHM=HS256" >> .env
          echo "ACCESS_TOKEN_EXPIRE_MINUTES=30" >> .env
      
      - name: Run tests
        run: |
          cd backend
          pytest ../tests/unit -v || true  # Continue for now
      
      - name: Upload coverage
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: backend-coverage
          path: tests/reports/coverage/backend/
          retention-days: 7

  deployment-safety-check:
    name: Deployment Safety Check
    runs-on: ubuntu-latest
    needs: [test-frontend]
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Build frontend
        run: |
          cd frontend
          npm run build:prod
      
      - name: Check for test files in build
        run: |
          bash scripts/testing/pre-deploy-check.sh
      
      - name: Verify no test files in production
        run: |
          # Additional safety check
          if find frontend/dist -type f -name "*.test.*" -o -name "*.spec.*" 2>/dev/null | grep -q .; then
            echo "âŒ Test files found in production build!"
            exit 1
          fi
          echo "âœ… Production build is clean"
      
      - name: Check build size
        run: |
          echo "Build size report:"
          du -sh frontend/dist
          find frontend/dist -type f -name "*.js" -exec ls -lh {} \; | head -10

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-frontend, test-e2e, test-ux-smoke, test-backend, deployment-safety-check]
    if: always()
    
    steps:
      - name: Test Results Summary
        run: |
          echo "## ğŸ“Š Test Suite Summary"
          echo ""
          echo "| Test Suite | Status |"
          echo "|------------|--------|"
          echo "| Frontend Unit Tests | ${{ needs.test-frontend.result == 'success' && 'âœ… Passed' || 'âš ï¸ Check Required' }} |"
          echo "| E2E Tests | ${{ needs.test-e2e.result == 'success' && 'âœ… Passed' || 'âš ï¸ Check Required' }} |"
          echo "| UX Smoke Tests (non-blocking) | ${{ needs.test-ux-smoke.result == 'success' && 'âœ… Passed' || 'âš ï¸ Non-blocking failure' }} |"
          echo "| Backend Tests | ${{ needs.test-backend.result == 'success' && 'âœ… Passed' || 'âš ï¸ Check Required' }} |"
          echo "| Deployment Safety | ${{ needs.deployment-safety-check.result == 'success' && 'âœ… Safe' || 'âŒ Failed' }} |"
          echo ""
          echo "### ğŸ”’ Deployment Safety: ${{ needs.deployment-safety-check.result == 'success' && 'Verified - No test files in production build' || 'Check failed - Review build output' }}"
